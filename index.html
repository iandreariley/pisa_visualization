<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    
    <style>
      circle.dimple-series-1 {
        fill: red;
      }

      .tooltip {
        visibility: visible;
      }

      .x.axis path {
        display: none;
      }

      .y.axis line, .y.axis path {
        fill: none;
        stroke: #000;
      }
}
    </style>

    <script type="text/javascript">

      // Global vars         
      var left_margin = 75,
          top_margin = 50,
          width = 1200 - left_margin,
          height = 700 - top_margin,
          radius = 4,
          chart_class = "chart",
          font = "Helvetica",
          text_color = "darkslategrey";

      var opening_text = "The graph below represents the mean score on the \
      2012 pisa math test by wealth bracket. Wealth, in this case, is\
      measured by the OECD index, which is calculated by the student's\
      possession of certain ammenities like his/her own room,\
      a computer, etc.",
      text_two = "The average score of students in the United States is\
      just above average, and 130 points below the average score of students\
      in Shanghai, China, which was the highest scoring individual group of\
      students in the 2012 PISA tests. However, there is less of a disparity\
      between the scores of rich and poor students in the U.S. than in\
      Shanghai."
      text_three = "Below are the average scores by wealth bracket of all of\
      the countries that participated in the PISA 2012 survey. Mouseover the\
      lines to highlight them and see further information";

      function x_axis(scale){
          return d3.svg.axis().scale(scale);
      };

      function y_axis(scale){
          return d3.svg.axis().scale(scale).orient("left");
      }

      function make_scale(pix_min, pix_max, dom){
          var scale = d3.scale.linear()
            .range([pix_min, pix_max])
            .domain(dom);

          return scale;
      };

      function clear_svg(){
          d3.selectAll("svg > *").remove();
      };

      //TODO: Find a better way to do this. D3 select function
      //probably not necessary.
      function no_existing_svg(){
          element = d3.select("svg")[0][0];
          return element === null;
      };

      function add_text(svg, x, y, text_string, stroke, text_class) {

        // Add text element to dom
        var text = svg.append('text')
          .attr("class", text_class)
          .attr('x', x)
          .attr('y', y)
          .style('font-family', 'Helvetica')
          .style('stroke', stroke)
          .style('font-size', 12)
          .style('font-weight', 300)
          .text(text_string);

        return text;
      };

      function add_arrow(svg, x1, y1, x2, y2) {

        var color = "black",
          weight = 2
        var line = draw_line(x1, y1, x2, y2, svg, text_color, weight)

        return line.attr('marker-end', 'url(#triangle)');
      }

      function get_country(country_array, country) {
        for(var i = 0; i < country_array.length; i++) {
          if (country_array[i]['key'] === country) {
            return country_array[i];
          }
        }
      }

      function get_country_mean(country_mean_array, country) {
          var result = null
          for(var i = 0; i < country_mean_array.length; i++) {
            if(country_mean_array[i]['key'] === country) {
              result = country_mean_array[i]['values'];
              return result.toFixed(0);
            }
          }
          return result;
      };

      function highlight(country) {
        d3.selectAll(".curve")
          .style("stroke-width", 1)
          .style("stroke", "grey")

        var selected = d3.select("#" + country)
          .style("stroke", "red")
          .style("stroke-width", 3);

      }

      function draw_line(x1, y1, x2, y2, svg, color, weight, dashed) {

        if( typeof(dashed) === 'undefined')
          dashed = false;
        var line = svg.append("svg:line")
          .attr('x1', x1)
          .attr('y1', y1)
          .attr('x2', x2)
          .attr('y2', y2)
          .style('stroke', color)
          .style('stroke-width', weight)

        if(dashed)
          return line.style('stroke-dasharray', "10,10");
        else
          return line;
      };

      // function draw_curve(svg, points_array, line_func, weight, color) {
      //     svg.append('svg:path')
      //         .attr('d', line_func(points_array))
      //         .attr('stroke', color)
      //         .attr('stroke-width', weight)
      //         .attr('fill', 'none');
      // };

      function comp_leaves(a,b) {
          return +a - +b;
      };

      function agg(leaves) {
          var mean_score = d3.mean(leaves, function(d) {
              return d['math_score'];
          });
          
          return {
            'country' : leaves[0]['country'],
            'x' : leaves[0]['wealth.bucket'],
            'y' : mean_score
          };
      };

      function draw(data) {
        "use strict";

        // Add SVG element to DOM
        var svg = d3.select("div.chart")
          .append("svg")
            .attr("width", width + left_margin)
            .attr("height", height + top_margin)
          .append('g')
            .attr('class', chart_class);

        // Mean test score by wealth bin across all countries
        var grand_mean = d3.nest()
          .key(function(d) {return d['wealth.bucket'];})
          .sortKeys(comp_leaves)
          .rollup(agg)
          .entries(data);

        // Add to array so that we can add it as a data element
        grand_mean = [grand_mean];

        // Mean test score by country
        var country_means = d3.nest()
          .key(function(d) { return d['country']})
          .rollup(function(leaves) {
            return d3.mean(leaves, function(d) {
              return d['math_score'];
            });
          })
          .entries(data);

        // Mean test score by wealth bin for each country in PISA set
        var countries = d3.nest()
          .key(function(d) {return d['country'];})
          .key(function(d) {return +d['wealth.bucket'];})
          .sortKeys(comp_leaves)
          .rollup(agg)
          .entries(data);

        // Bind data to path elements and chart
        var lines = svg.selectAll('path')
          .data(countries)
          .enter()

        // Find range of date column
        var wealth_extent = d3.extent(data, function(d) {
            return +d['wealth.bucket'];
        });

        // Find range of attendance column
        var score_extent = d3.extent(data, function(d) {
            return d['math_score'];
        });

        // Create x and y scales mapping values to pixels
        var wealth_scale = make_scale(left_margin, width, wealth_extent);
        var score_scale = d3.scale.linear()
          .range([height, top_margin])
          .domain([0, 650]);

        // Create axes
        var wealth_axis = x_axis(wealth_scale);
        var score_axis = y_axis(score_scale);

        // Draw axes to graph
        d3.select("svg")
          .append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(wealth_axis);

        d3.select("svg")
          .append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + left_margin + ",0)")
          .call(score_axis);

        // Curve-drawing function
        var line = d3.svg.line()
          .x(function(d) {
            return wealth_scale(d['values']['x']);
          })
          .y(function(d) {
            return score_scale(d['values']['y']);
          })
          .interpolate('basis');

        var us = 'United States of America',
            china = 'China-Shanghai',
            us_color = 'blue',
            china_color = "gold";

        function stage_one() {

          // Draw grand mean
          var mean_line = svg.selectAll('path')
            .data(grand_mean)
            .enter()
            .append('path')
            .attr('d', function(d){return line(d);})
            .style('fill', 'none')
            .style('stroke', 'darkslategrey')
            .style('stroke-width', 3);
        };

        function stage_two() {

          // make an arrow marker
          // lifted wholesale from Mozilla Developer Nework
          svg.append('defs')
            .append('marker')
            .attr('id', 'triangle')
            .attr('viewBox', "0 0 10 10")
            .attr('refX', 1)
            .attr('refY', 5)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 0 0 L 10 5 L 0 10 z');

          //draw high low lines
          var high_line = draw_line(left_margin, score_scale(500), 
            width, score_scale(500), svg, 'grey', 2, true);

          var low_line = draw_line(left_margin, score_scale(359),
            width, score_scale(359), svg, 'grey', 2, true);

          // draw arrows and text highlighting score difference over wealth
          add_arrow(svg, wealth_scale(.9), score_scale(450),
            wealth_scale(.9), score_scale(495));
          add_arrow(svg, wealth_scale(.9), score_scale(409),
            wealth_scale(.9), score_scale(364));
          add_text(svg, wealth_scale(0), score_scale(430),
            '140 points > 3 years of schooling');
        };

        function stage_three() {

          // remove previous highlight lines and change text
          svg.selectAll('line').remove();
          svg.selectAll('text').remove();
          text_box.text(text_two);

          // draw mean lines for us and shanghai
          var us_mean = score_scale(get_country_mean(country_means, us)),
              china_mean = score_scale(get_country_mean(country_means, china)),
              us_mean_line = draw_line(left_margin, us_mean, width, us_mean,
                svg, us_color, 2, true),
              china_mean_line = draw_line(left_margin, china_mean, width,
                china_mean, svg, china_color, 2, true);

          // Label mean lines with text
          add_text(svg, wealth_scale(1.2), score_scale(640),
            'Shanghai (China)');
          add_text(svg, wealth_scale(2.1), score_scale(500),
            'USA')

          // draw lines and text highlighting difference between China and US
          add_arrow(svg, wealth_scale(-5), score_scale(557),
            wealth_scale(-5), score_scale(607));
          add_arrow(svg, wealth_scale(-5), score_scale(537),
            wealth_scale(-5), score_scale(487));
          add_text(svg, wealth_scale(-6), score_scale(547),
            '130 points = 3 years schooling', 'grey', "mean_text");

          // Bind data to path elements and chart
          var lines = svg.selectAll('path')
            .data(countries)
            .enter()

          // Draw US and china curves in their respective colors
          var first_lines = lines.append('path')
            .filter(function(d) {
              return d['key'] === us || d['key'] === china;
            })
            .attr("id", function(d) {
              return d['key'].replace(/ /g, '-');
            })
            .attr("class", "curve first_lines")
            .attr('d', function(d){
              return line(d['values']);})
            .style('fill', 'none')
            .style('stroke', function(d) {
              if(d['key'] === us) {
                return us_color;
              } else {
                return china_color;
              }
            })
            .style('stroke-width', 2)
        };

        function stage_four() {

          // Draw max/min lines for china and the us
          svg.selectAll("line").remove()
          svg.selectAll(".mean_text").remove();
          draw_line(left_margin, score_scale(402), width, score_scale(402),
            svg, us_color, 2, true);
          draw_line(left_margin, score_scale(509), width, score_scale(509),
            svg, us_color, 2, true);
          draw_line(left_margin, score_scale(455), width, score_scale(455),
            svg, china_color, 2, true);
          draw_line(left_margin, score_scale(640), width, score_scale(640),
            svg, china_color, 2, true);

          // Add arrows highlightening difference between max and min
          add_arrow(svg, wealth_scale(-5), score_scale(635-75),
            wealth_scale(-5), score_scale(630));
          add_arrow(svg, wealth_scale(-5), score_scale(455 + 75),
            wealth_scale(-5), score_scale(460));
          add_arrow(svg, wealth_scale(-5.5), score_scale(509 - 40),
            wealth_scale(-5.5), score_scale(504));
          add_arrow(svg, wealth_scale(-5.5), score_scale(402 + 40),
            wealth_scale(-5.5), score_scale(407));

          // Add text explaining difference in terms of years of schooling
          add_text(svg, wealth_scale(-5.5), score_scale(545),
            "180 points > 3 years", 'grey', "span")
          add_text(svg, wealth_scale(-5.4), score_scale(425),
            "100 points > 2 years", 'grey', "span")
        };

        function stage_five() {


          // set us and china lines to standard line color
          svg.selectAll(".first_lines")
            .style('stroke', 'grey')
            .style('stroke-width', 1)
            .on('mouseover', function(d){
              return d3.select(this).style('stroke', 'red')
                .style('stroke-width', 3);
            })
            .on('mouseout', function(d){
              return d3.select(this).style('stroke', 'slategrey')
                .style('stroke-width', 1);
            })
            .append("svg:title")
            .attr("class", "tooltip")
            .text(function(d) {
              var values = d['values'][0]['values'];
              var country = values['country'];
              var score = get_country_mean(country_means, country);
              return country + '\nAverage Score: ' + score;
            });

          // change text_box text
          text_box.text(text_three);

          // remove all highlighting text and arrows
          svg.selectAll('line').remove();
          svg.selectAll('text').remove();

          var final_chart = lines.append('path')
            .filter(function(d) {
              return d['key'] !== us && d['key'] !== china;
            })
            .attr("id", function(d) { return d['key'].replace(/ /g, '-'); })
            .attr("class", "curve")
            .attr('d', function(d){
              return line(d['values']);})
            .style('fill', 'none')
            .style('stroke', 'grey')
            .style('stroke-width', 1)
            .on('mouseover', function(d){
              return d3.select(this).style('stroke', 'red')
                .style('stroke-width', 3);
            })
            .on('mouseout', function(d){
              return d3.select(this).style('stroke', 'slategrey')
                .style('stroke-width', 1);
            });

          // Add tooltips to lines
          final_chart.append("svg:title")
            .attr("class", "tooltip")
            .text(function(d) {
              var values = d['values'][0]['values'];
              var country = values['country'];
              var score = get_country_mean(country_means, country);
              return country + '\nAverage Score: ' + score;
            });

          // Remove 'next' button, as this is the last page
          button.remove();

          // Add a <select> element to allow user to highlight country
          var country_selector = header.append("select")
            .attr("float", "right")
            .on("change", highlighter)

          var options = country_selector.selectAll("option")
            .data(countries);

          options.enter()
            .append("option")
            .attr("value", function(d) { return d['key']; })
            .text(function(d) { return d['key']; });

          function highlighter() {
            var index = country_selector.property("selectedIndex");
            var selected_country = options[0][index]['__data__']['key'];
            selected_country = selected_country.replace(/ /g, '-');
            console.log(selected_country);
            highlight(selected_country);
          };
        };

        var stage_array = [stage_one, stage_two, stage_three, stage_four,
                          stage_five];
        var stidx = 0;

        button.on("click", function(d){
          if(stidx < stage_array.length){
            stage_array[stidx]();
            stidx += 1;
          }
        });
      };

    </script>
  </head>
<body>
  <script type="text/javascript">

  var header_margin = 10

  var header = d3.select("body")
    .append("div")
    .attr("class", "header")
    .style("margin-left", left_margin + "px")
    .style("width", width - left_margin + "px")
    .style("height", "75px")
    .style("display", "block")

  var title = header.append("h2")
    .style("padding-left", header_margin + "px")
    .style("font-family", font)
    .style("color", text_color)
    .text("PISA 2012 Math Score by Wealth");

  var text_box = header.append("div")
    .attr("class", "text_box")
    .style("padding-left", header_margin + "px")
    .style("width", width - left_margin - 200 +"px")
    .style("height", "50px")
    .style("word-wrap", "break-word")
    .style("font-family", font)
    .style("float", "left")
    .style("color", text_color)
    .text(opening_text);
        
  //Create navigation button
  var button = header.append("div")
    .attr("class", "next_button")
    .style("display", "table")
    .style("width", "75px")
    .style("height", "25px")
    .style("float", "right")
    .append("div")
    .style("display", "table-cell")
    .style("border-radius", "5px")
    .style("vertical-align", "middle")
    .style("text-align", "center")
    .style("background", "darkslategrey")
    .style("color", "white")
    .text("NEXT");

  var chart = d3.select("body")
  .append("div")
  .attr("class", chart_class)
  .attr("width", width)
  .attr("height", height)
  .style("display", "block")

  var chart_buttons = chart.append("div")
    .attr("float", "right")

  var obj = draw_first_stage("pisa_by_wealth.tsv");

  function draw_first_stage(file){
      d3.tsv(file, function(d) {
          // transform data
          d['math_score'] = +d['math_score'];
          d['wealth.bucket'] = +d['wealth.bucket'];
          return d;
      }, draw);
  };
  </script>
</body>
</html>
