<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    
    <style>
      circle.dimple-series-1 {
        fill: red;
      }

      .tooltip {
        visibility: visible;
      }

      .axis line, .axis path {
        fill: none;
        stroke: #000;
      }
}
    </style>

    <script type="text/javascript">

      // Global vars         
      var left_margin = 75,
          top_margin = 50,
          width = 1200 - left_margin,
          height = 700 - top_margin,
          chart_class = "chart",
          font = "Helvetica",
          mean_width = 3,
          highlight_width = 3,
          dash_line_width = 2,
          line_width = 1,
          highlight_color = "red",
          curve_color = "grey",
          text_color = "darkslategrey",
          mean_color = "darkslategrey",
          font_size = 12,
          font_weight = 300;

      var text_one = "The following data were taken from the 2012 Programme \
      for International Student Assessment (PISA) dataset. These data \
      represent the math scores and wealth of over half a million students \
      in 68 economies. PISA tests (which cover the areas of math, science and \
      reading) aim to assess whether students at the end of compulsory \
      education can apply their learning to real-life situations, rather than \
      testing a specific curriculum.",
      text_two = "The line below represents average score on the PISA math \
      test by wealth bracket. PISA uses its own index to \
      measure wealth, rather than a monetary metric like yearly income. This \
      accounts for the fact that the amount of income that constitutes \
      \"wealth\" may differ between nations. The PISA index is based on a \
      student's access to certain amenities, like his/her own place to study, \
      a DVD player, etc.",
      text_three  = "The difference between the lowest scoring wealth bracket \
      and the highest scoring is about 140 points, which PISA estimates \
      represents about three years of schooling (41 points = 1 year).",
      text_four = "Shown here is a comparison between two of the world's top \
      economies - the United States, and Shanghai (China has yet to implement \
      nation-wide PISA tests). Shanghai has the highest average math score in \
      the 2012 PISA dataset. The average for the United States is 130 points \
      below Shanghai, which suggests that the average American 15 year-old \
      would need another three years of school to catch up with his/her \
      counterpart in Shanghai.",
      text_five = "However, the data also suggest that United States \
      education is more equitable. The difference between the USA's lowest \
      scoring and highest scoring brackets is 100 points, or about two and a \
      half years of schooling. In Shanghai that difference is 180 points, or \
      more than 4 years by PISA estimations.",
      text_six = "Below are the wealth-score curves for all of the economies \
      that participated in the 2012 PISA assessment. Mouse over lines to view \
      the name and mean score of an economy, or select countries by name in \
      the drop menu on the right.";

      var title_one = "The PISA 2012 Dataset",
          title_two = "Correlation of Wealth and Math Skills",
          title_three = "Wealth and Math Skills",
          title_four = "Comparing Two Economies",
          title_five = "Equitability Within an Economy",
          title_six = "Exploring Wealth and Education";

      function add_button(parent, text) {
        return parent.append("div")
          .style("display", "table-cell")
          .style("border-radius", "5px")
          .style("vertical-align", "middle")
          .style("text-align", "center")
          .style("background", text_color)
          .style("color", "white")
          .style("border-color", "white")
          .style("border-color", "white")
          .style("border", "solid 1px")
          .text(text);
      }

      function x_axis(scale){
          return d3.svg.axis().scale(scale);
      };

      function y_axis(scale){
          return d3.svg.axis().scale(scale).orient("left");
      }

      function make_scale(pix_min, pix_max, dom){
          var scale = d3.scale.linear()
            .range([pix_min, pix_max])
            .domain(dom);

          return scale;
      };

      function selector_from_string(str) {
        // Replace spaces with hyphens and remove parens
        return str.replace(/ /g, "-").replace(/\(|\)/g, "");
      }

      function add_text(svg, x, y, text_string, stroke, text_class) {

        // Add text element to dom
        var text = svg.append("text")
          .attr("class", text_class)
          .attr("x", x)
          .attr("y", y)
          .style("font-family", font)
          .style("stroke", stroke)
          .style("font-size", font_size)
          .style("font-weight", font_weight)
          .text(text_string);

        return text;
      };

      // filter function from
      // http://stackoverflow.com/questions/7378228/
      // check-if-value-is-in-array-with-javascript
      function filter_by_key(data, keys) {
        return data.filter(function(d) {
          return keys.indexOf(d["key"]) > -1;
        });
      };

      function add_arrow(svg, x1, y1, x2, y2) {

        var color = "black",
          weight = 2,
          diff = 8;

        // Shorten length of arrow to account for marker end
        if (y2 - y1 < 0)
          y2 += diff;
        else
          y2 -= diff;
        var line = draw_line(x1, y1, x2, y2, svg, text_color, weight)

        return line.attr("marker-end", "url(#triangle)");
      };

      function get_country(country_array, country) {
        for(var i = 0; i < country_array.length; i++) {
          if (country_array[i]["key"] === country) {
            return country_array[i];
          }
        }
      }

      function get_country_mean(country_mean_array, country) {
          var result = null;
          for(var i = 0; i < country_mean_array.length; i++) {
            if(country_mean_array[i]["key"] === country) {
              result = country_mean_array[i]["values"];
              return parseInt(result.toFixed(0));
            }
          }
          return result;
      };

      function highlight(country) {
        d3.selectAll(".country")
          .style("stroke-width", line_width)
          .style("stroke", "grey");

        d3.selectAll("mean")
          .style("stroke", mean_color);

        var selected = d3.select("#" + country)
          .style("stroke", highlight_color)
          .style("stroke-width", highlight_width);

      };

      function trim_curves(svg, data) {
        var kill = svg.selectAll("path")
          .data(data)
          .exit()
          .remove();
      };

      function draw_curves(selection, data, line_func, stroke, stroke_width) {

          return selection.data(data)
            .enter()
            .append("path")
            .attr("d", function(d) {return line_func(d["values"]); })
            .style("fill", "none")
            .style("stroke", stroke)
            .style("stroke-width", stroke_width)
            .attr("id", function(d) { return selector_from_string(d["key"]); })
            .attr("class", function(d) {
              if(d["key"] !== "mean")
                return "country";
              return "mean";
            });
      }

      function clear_annotations(svg) {
          svg.selectAll("line").remove();
          svg.selectAll("text").remove();
      }

      function draw_line(x1, y1, x2, y2, svg, color, weight, dashed) {

        if( typeof(dashed) === "undefined")
          dashed = false;
        var line = svg.append("svg:line")
          .attr("x1", x1)
          .attr("y1", y1)
          .attr("x2", x2)
          .attr("y2", y2)
          .style("stroke", color)
          .style("stroke-width", weight);

        if(dashed)
          return line.style("stroke-dasharray", "10,10");
        else
          return line;
      };

      function comp_leaves(a,b) {
          return +a - +b;
      };

      function agg(leaves) {
          var mean_score = d3.mean(leaves, function(d) {
              return d["math_score"];
          });
          
          return {
            "country" : leaves[0]["country"],
            "x" : leaves[0]["wealth.bucket"],
            "y" : mean_score
          };
      };

      function update_text(text_title, text_body) {
        d3.select(".header h2")
          .text(text_title);
        d3.select(".text_box")
          .text(text_body);
      }

      function draw(data) {
        "use strict";

        // Add SVG element to DOM
        var svg = d3.select("div.chart")
          .append("svg")
            .attr("width", width + left_margin)
            .attr("height", height + top_margin)
          .append("g")
            .attr("class", chart_class);

        // Mean test score by wealth bin across all countries
        var grand_mean = d3.nest()
          .key(function(d) {return d["wealth.bucket"];})
          .sortKeys(comp_leaves)
          .rollup(agg)
          .entries(data);

        // Mean test score by country
        var country_means = d3.nest()
          .key(function(d) { return d["country"]})
          .rollup(function(leaves) {
            return d3.mean(leaves, function(d) {
              return d["math_score"];
            });
          })
          .entries(data);

        // Mean test score by wealth bin for each country in PISA set
        var countries = d3.nest()
          .key(function(d) {return d["country"];})
          .key(function(d) {return +d["wealth.bucket"];})
          .sortKeys(comp_leaves)
          .rollup(agg)
          .entries(data);

        var mean_score = d3.nest()
          .rollup(function(leaves) {
            return d3.mean(leaves, function(d) {
              return d["math_score"];
            });
          })
          .entries(data);

        // Add to array so that we can add it as a data element
        grand_mean = {"key" : "mean",
                      "values" : grand_mean};

        countries.push(grand_mean);

        // Bind data to path elements and chart
        var lines = svg.selectAll("path")
          .data(countries)
          .enter()

        // Find range of date column
        var wealth_extent = d3.extent(data, function(d) {
            return +d["wealth.bucket"];
        });

        // Find range of attendance column
        var score_extent = d3.extent(data, function(d) {
            return d["math_score"];
        });

        // Create x and y scales mapping values to pixels
        var max_y = 650,
            min_y = 0;
        var wealth_scale = make_scale(left_margin, width, wealth_extent);
        var score_scale = d3.scale.linear()
          .range([height, top_margin])
          .domain([min_y, max_y]);

        // Create axes
        var wealth_axis = x_axis(wealth_scale);
        var score_axis = y_axis(score_scale);

        // Draw axes to graph
        d3.select("svg")
          .append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(wealth_axis);

        d3.select("svg")
          .append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + left_margin + ",0)")
          .call(score_axis);

        //Draw labels to graph
        d3.select("svg")
          .append("text")
          .attr("class", "x label")
          .attr("text-anchor", "middle")
          .attr("x", (width - left_margin)/2 + left_margin )
          .attr("y", top_margin + height)
          .text("Wealth");

        var y_lab_offset = 20;
        d3.select("svg")
          .append("text")
          .attr("class", "y label")
          .attr("text-anchor", "middle")
          .attr("y", y_lab_offset)
          .attr("x", -(height/2))
          .attr("transform", "rotate(-90)")
          .text("PISA Math Score");

        // make an arrow marker
        // Attach to parent svg element so it isn't deleted by
        // chart clearing functions.
        // lifted wholesale from Mozilla Developer Nework
        var m_width = 5,
            m_height = m_width,
            ref_x = 1,
            ref_y = 5;
        d3.select("svg").append("defs")
          .append("marker")
          .attr("id", "triangle")
          .attr("viewBox", "0 0 10 10")
          .attr("refX", ref_x)
          .attr("refY", ref_y)
          .attr("markerWidth", m_width)
          .attr("markerHeight", m_height)
          .attr("orient", "auto")
          .append("path")
          .style("stroke", text_color)
          .style("fill", text_color)
          .attr("d", "M 0 0 L 10 5 L 0 10 z");

        // Curve-drawing function
        var line = d3.svg.line()
          .x(function(d) {
            return wealth_scale(d["values"]["x"]);
          })
          .y(function(d) {
            return score_scale(d["values"]["y"]);
          })
          .interpolate("basis");

        var us = "United States of America",
            china = "China-Shanghai",
            us_color = "blue",
            china_color = "gold";

        // Path selection for adding/removing country curves to chart
        var curves = svg.selectAll("path");

        function draw_span(min_score, max_score, x, arr_length,
          arr_offset, hi_color, lo_color) {

          if(typeof(lo_color) === "undefined")
            if(typeof(hi_color) === "undefined") {
              hi_color = curve_color;
              lo_color = curve_color;
            } else
              lo_color = hi_color;

          debugger;
          var hi_line_y = score_scale(max_score),
              lo_line_y = score_scale(min_score),
              arr_x = wealth_scale(x);

          //draw high low lines
          draw_line(left_margin, hi_line_y, width, hi_line_y, svg,
            hi_color, dash_line_width, true);
          draw_line(left_margin, lo_line_y, width, lo_line_y, svg,
            lo_color, dash_line_width, true);
          debugger;
          var top_arrow_end = score_scale(max_score - arr_length),
              bot_arrow_end = score_scale(min_score + arr_length),
              top_arrow_tip = score_scale(max_score) + arr_offset,
              bot_arrow_tip = score_scale(min_score) - arr_offset;
          debugger;
          // draw arrows and text highlighting score difference over wealth
          add_arrow(svg, arr_x, top_arrow_end, arr_x, top_arrow_tip);
          add_arrow(svg, arr_x, bot_arrow_end, arr_x, bot_arrow_tip);

        }

        function stage_one() {

          update_text(title_two, text_two);

          // Remove any unecessary curves from chart (all but one)
          // as well as any text annotation or lines
          // Draw selected cureves (mean) to remaining paths
          clear_annotations(svg);
          var mean = filter_by_key(countries, ["mean"]);
          trim_curves(svg, []);
          draw_curves(curves, mean, line, mean_color, mean_width);
        };

        function stage_two() {

          update_text(title_three, text_three);

          var mean = filter_by_key(countries, ["mean"]);
          clear_annotations(svg);
          trim_curves(svg, []);
          draw_curves(curves, mean, line, mean_color, mean_width);

          var max_score = 500,
              min_score = 359,
              offset = 5,
              arrow_length = 50,
              x = .9,
              text_y = score_scale((max_score + min_score)/2);

          draw_span(min_score, max_score, x, arrow_length, offset);
          add_text(svg, wealth_scale(0), text_y,
            "140 points > 3 years of schooling");
        };

        function stage_three() {

          update_text(title_four, text_four);

          var curves_to_draw = filter_by_key(countries, ["mean", us, china]);

          // remove previous highlight lines and change text
          clear_annotations(svg);
          trim_curves(svg, []);
          draw_curves(curves, curves_to_draw, line,
            function(d) {
              if(d["key"] === us)
                return us_color;
              else if(d["key"] === china)
                return china_color;
              else
                return mean_color;
            },
            function(d) {
              if(d["key"] === us || d["key"] === china)
                return 2;
              else
                return 3;
            });

          var china_score = get_country_mean(country_means, china),
              us_score = get_country_mean(country_means, us),
              offset = 5,
              arrow_length = 50,
              x = -5,
              text_y = score_scale((china_score + us_score)/2);

          draw_span(us_score, china_score, x, arrow_length, offset,
            china_color, us_color);

          // Label mean lines with text
          add_text(svg, wealth_scale(1.2), score_scale(640),
            "Shanghai (China)");
          add_text(svg, wealth_scale(2.1), score_scale(500),
            "USA")
          add_text(svg, wealth_scale(-6), score_scale(547),
            "130 points = 3 years schooling", curve_color, "mean_text");
        };

        function stage_four() {

          update_text(title_five, text_five);

          var curves_to_draw = filter_by_key(countries, ["mean", us, china]);

          // remove previous highlight lines and change text
          d3.select("select").remove();
          clear_annotations(svg);
          trim_curves(svg, []);
          draw_curves(curves, curves_to_draw, line,
            function(d) {
              if(d["key"] === us)
                return us_color;
              else if(d["key"] === china)
                return china_color;
              else
                return mean_color;
            },
            function(d) {
              if(d["key"] === us || d["key"] === china)
                return 2;
              else
                return 3;
            });

          var us_max = 509,
              us_min = 402,
              us_x = -5.5,
              us_arr_len = 40,
              china_max = 640,
              china_min = 455,
              china_x = -5,
              china_arr_len = 75,
              offset = 5;

          draw_span(us_min, us_max, us_x, us_arr_len, offset, us_color);
          draw_span(china_min, china_max, china_x, china_arr_len, offset,
            china_color);

          // Add text explaining difference in terms of years of schooling
          add_text(svg, wealth_scale(-5.5), score_scale(545),
            "180 points > 3 years", text_color, "span")
          add_text(svg, wealth_scale(-5.4), score_scale(425),
            "100 points > 2 years", text_color, "span")
        };

        function stage_five() {

          update_text(title_six, text_six);

          clear_annotations(svg);
          trim_curves(svg, []);

          var country_curves = draw_curves(curves, countries, line,
            function(d) {
              if(d["key"] === "mean")
                return mean_color;
              return curve_color;
            },
            function(d) {
              if(d["key"] === "mean")
                return 3;
              return 1;
            })
            .on("mouseover", function(d){
              highlight(selector_from_string(d["key"]));
            })
            .on("mouseout", function(d){
              if(d["key"] === "mean")
                return d3.select(this).style("stroke", mean_color);
              return d3.select(this).style("stroke", curve_color)
                .style("stroke-width", 1);
            });

          // Add tooltips to lines
          country_curves.append("svg:title")
            .attr("class", "tooltip")
            .text(function(d) {
              if(d["key"] === "mean")
                return "Mean\nAverage Score: " + mean_score.toFixed();
              var values = d["values"][0]["values"];
              var country = values["country"];
              var score = get_country_mean(country_means, country);
              return country + "\nAverage Score: " + score;
            });

          // Add a <select> element to allow user to highlight country
          var country_selector = header.append("select")
            .style("float", "right")
            .style("margin-top", "3px")
            .on("change", highlighter)

          // Sort countries variable and bind data to <option> elements
          var options = country_selector.selectAll("option")
            .data(countries.sort(function(a, b) {
              if(a["key"] < b["key"])
                return -1;
              else if (a["key"] > b["key"])
                return 1;
              return 0;
            }));

          options.enter()
            .append("option")
            .attr("value", function(d) { return d["key"]; })
            .text(function(d) { return d["key"]; });

          function highlighter() {
            var index = country_selector.property("selectedIndex");
            var selected_country = options[0][index]["__data__"]["key"];
            selected_country = selector_from_string(selected_country);
            console.log(selected_country);
            highlight(selected_country);
          };
        };

        var stage_array = [stage_one, stage_two, stage_three, stage_four,
                          stage_five];
        var stidx = 0;

        // Add click events to header buttons
        next_button.on("click", function(d){
          if(stidx < stage_array.length){
            stage_array[stidx]();
            stidx += 1;
          }
        });

        prev_button.on("click", function(d) {
          if(stidx > 1) {
            stage_array[stidx - 2]();
            stidx -= 1;
          }
        })
      };

    </script>
  </head>
<body>
  <script type="text/javascript">

  var header_margin = 10

  var header = d3.select("body")
    .append("div")
    .attr("class", "header")
    .style("margin-left", left_margin + "px")
    .style("width", width - left_margin + "px")
    .style("height", "75px")
    .style("display", "block")

  var title = header.append("h2")
    .style("padding-left", header_margin + "px")
    .style("font-family", font)
    .style("color", text_color)
    .text(title_one);

  var text_box = header.append("div")
    .attr("class", "text_box")
    .style("padding-left", header_margin + "px")
    .style("width", width - left_margin - 200 +"px")
    .style("height", "50px")
    .style("word-wrap", "break-word")
    .style("font-family", font)
    .style("float", "left")
    .style("color", text_color)
    .text(text_one);
        
  //Create navigation button
  var button_panel = header.append("div")
    .attr("class", "button")
    .style("display", "table")
    .style("width", "150px")
    .style("height", "25px")
    .style("float", "right");

  var prev_button = add_button(button_panel, "PREV");

  var next_button = add_button(button_panel, "NEXT");

  var chart = d3.select("body")
  .append("div")
  .attr("class", chart_class)
  .attr("width", width)
  .attr("height", height)
  .style("display", "block")

  var chart_buttons = chart.append("div")
    .attr("float", "right")

  var obj = draw_first_stage("pisa_by_wealth.tsv");

  function draw_first_stage(file){
      d3.tsv(file, function(d) {
          // transform data
          d["math_score"] = +d["math_score"];
          d["wealth.bucket"] = +d["wealth.bucket"];
          return d;
      }, draw);
  };
  </script>
</body>
</html>
