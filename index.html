<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
    
    <style>
      circle.dimple-series-1 {
        fill: red;
      }

      .tooltip {
        visibility: visible;
      }

      .x.axis path {
        display: none;
      }

      .y.axis line, .y.axis path {
        fill: none;
        stroke: #000;
      }
}
    </style>

    <script type="text/javascript">

      // Global vars         
      var left_margin = 75,
          top_margin = 50,
          width = 1200 - left_margin,
          height = 700 - top_margin,
          radius = 4,
          chart_class = "chart"
          font = "Helvetica"
          text_color = "darkslategrey";

      var opening_text = "The graph below represents the mean score on the \
      2012 pisa math test by wealth bracket. Wealth, in this case, is\
      measured by the OECD index, which is calculated by the student's\
      possession of certain ammenities like his/her own room,\
      a computer, etc.",
      text_two = "The average score of students in the United States is\
      just above average, and 130 points below the average score of students\
      in Shanghai, China, which was the highest scoring individual group of\
      students in the 2012 PISA tests. However, there is less of a disparity\
      between the scores of rich and poor students in the U.S. than in\
      Shanghai."
      text_three = "Below are the average scores by wealth bracket of all of\
      the countries that participated in the PISA 2012 survey. Mouseover the\
      lines to highlight them and see further information";

      function x_axis(scale){
          return d3.svg.axis().scale(scale);
      };

      function y_axis(scale){
          return d3.svg.axis().scale(scale).orient("left");
      }

      function make_scale(pix_min, pix_max, dom){
          var scale = d3.scale.linear()
            .range([pix_min, pix_max])
            .domain(dom);

          return scale;
      };

      function clear_svg(){
          d3.selectAll("svg > *").remove();
      };

      //TODO: Find a better way to do this. D3 select function
      //probably not necessary.
      function no_existing_svg(){
          element = d3.select("svg")[0][0];
          return element === null;
      };

      function make_svg_element(width, top_margin, left_margin,
       height, css_class){
          var svg = d3.select("body")
            .append("svg")
              .attr("width", width + left_margin)
              .attr("height", height + top_margin)
            .append('g')
              .attr('class', css_class);

          return svg;
      };

      function add_text(svg, x, y, text_string, stroke) {
        if (typeof(stroke) === 'undefined')
          stroke = 'grey';
        return svg.append('text')
          .attr('x', x)
          .attr('y', y)
          .style('font-family', 'Helvetica')
          .style('stroke', stroke)
          .style('font-size', 12)
          .style('font-weight', 300)
          .text(text_string);
      };

      function add_arrow(svg, x1, y1, x2, y2) {

        var color = "black",
          weight = 2
        var line = draw_line(x1, y1, x2, y2, svg, text_color, weight)

        return line.attr('marker-end', 'url(#triangle)');
      }

      function get_country(country_array, country) {
        for(var i = 0; i < country_array.length; i++) {
          if (country_array[i]['key'] === country) {
            return country_array[i];
          }
        }
      }

      function get_country_mean(country_mean_array, country) {
          var result = null
          for(var i = 0; i < country_mean_array.length; i++) {
            if(country_mean_array[i]['key'] === country) {
              result = country_mean_array[i]['values'];
              return result.toFixed(0);
            }
          }
          return result;
      };

      function draw_line(x1, y1, x2, y2, svg, color, weight, dashed) {

        if( typeof(dashed) === 'undefined')
          dashed = false;
        var line = svg.append("svg:line")
          .attr('x1', x1)
          .attr('y1', y1)
          .attr('x2', x2)
          .attr('y2', y2)
          .style('stroke', color)
          .style('stroke-width', weight)

        if(dashed)
          return line.style('stroke-dasharray', "10,10");
        else
          return line;
      };

      // function draw_curve(svg, points_array, line_func, weight, color) {
      //     svg.append('svg:path')
      //         .attr('d', line_func(points_array))
      //         .attr('stroke', color)
      //         .attr('stroke-width', weight)
      //         .attr('fill', 'none');
      // };

      function comp_leaves(a,b) {
          return +a - +b;
      };

      function agg(leaves) {
          var mean_score = d3.mean(leaves, function(d) {
              return d['math_score'];
          });
          
          return {
            'country' : leaves[0]['country'],
            'x' : leaves[0]['wealth.bucket'],
            'y' : mean_score
          };
      };

      function stage_one(data) {
          "use strict";

          // Handle whether graph has already been created
          if(no_existing_svg()){
              var svg = make_svg_element(width, top_margin, left_margin,
                height, chart_class);
          }
          else{
              clear_svg();
          }

          // Create mean by wealth bin
          var grand_mean = d3.nest()
            .key(function(d) {return d['wealth.bucket'];})
            .sortKeys(comp_leaves)
            .rollup(agg)
            .entries(data);

          // mean scores by country
          var country_means = d3.nest()
            .key(function(d) { return d['country']})
            .rollup(function(leaves) {
              return d3.mean(leaves, function(d) {
                return d['math_score'];
              });
            })
            .entries(data)


          grand_mean = [grand_mean];

          // Find range of date column
          var wealth_extent = d3.extent(data, function(d) {
              return +d['wealth.bucket'];
          });

          // Find range of attendance column
          var score_extent = d3.extent(data, function(d) {
              return d['math_score'];
          })

          // Create x and y scales mapping values to pixels
          var wealth_scale = make_scale(left_margin, width, wealth_extent);
          var score_scale = d3.scale.linear()
            .range([height, top_margin])
            .domain([0, 650]);

          // Create axes
          var wealth_axis = x_axis(wealth_scale);
          var score_axis = y_axis(score_scale);

          // Draw axes to graph
          d3.select("svg")
            .append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(wealth_axis);

          d3.select("svg")
            .append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + left_margin + ",0)")
            .call(score_axis);

          // Create line drawing function
          var line = d3.svg.line()
            .x(function(d) {
              return wealth_scale(d['values']['x']);
            })
            .y(function(d) {
              return score_scale(d['values']['y']);
            })
            .interpolate('basis');

          // Draw grand mean
          var mean_line = svg.selectAll('path')
            .data(grand_mean)
            .enter()
            .append('path')
            .attr('d', function(d){return line(d);})
            .style('fill', 'none')
            .style('stroke', 'darkslategrey')
            .style('stroke-width', 3);

          return {
            'data' : data,
            'svg' : svg,
            'wealth_scale' : wealth_scale,
            'score_scale' : score_scale,
            'wealth_axis' : wealth_axis,
            'score_axis' : score_axis,
            'country_means' : country_means
          };
      };

      function stage_two(data, svg, country_means, wealth_scale, score_scale,
        wealth_axis, score_axis) {


        // make an arrow marker
        // lifted wholesale from Mozilla Developer Nework
        svg.append('defs')
          .append('marker')
          .attr('id', 'triangle')
          .attr('viewBox', "0 0 10 10")
          .attr('refX', 1)
          .attr('refY', 5)
          .attr('markerWidth', 6)
          .attr('markerHeight', 6)
          .attr('orient', 'auto')
          .append('path')
          .attr('d', 'M 0 0 L 10 5 L 0 10 z')

        //draw high low lines
        high_line = draw_line(left_margin, score_scale(500), 
          width, score_scale(500), svg, 'grey', 2, true)

        low_line = draw_line(left_margin, score_scale(359),
          width, score_scale(359), svg, 'grey', 2, true)

        // draw arrows and text highlighting score difference over wealth
        add_arrow(svg, wealth_scale(.9), score_scale(450),
          wealth_scale(.9), score_scale(495));
        add_arrow(svg, wealth_scale(.9), score_scale(409),
          wealth_scale(.9), score_scale(364));
        add_text(svg, wealth_scale(0), score_scale(430),
          '140 points > 3 years of schooling');
      };

      function stage_three(vals) {
        
      // open up values object
        var wealth_scale = vals.wealth_scale;
        var score_scale = vals.score_scale;
        var country_means = vals['country_means'];
        var svg = vals.svg;
        var data = vals['data'];

        // get mean scores per wealth group per country
        var countries = d3.nest()
          .key(function(d) {return d['country'];})
          .key(function(d) {return +d['wealth.bucket'];})
          .sortKeys(comp_leaves)
          .rollup(agg)
          .entries(data);

        // Create line function for path elements
        var line = d3.svg.line()
          .x(function(d) {
            return wealth_scale(d['values']['x']);
          })
          .y(function(d) {
            return score_scale(d['values']['y']);
          })
          .interpolate('basis');

        var us = 'United States of America',
            china = 'China-Shanghai';
        
        setTimeout(function(values) {

          var us_color = 'blue',
              china_color = "gold";

          // remove previous highlight lines and change text
          svg.selectAll('line').remove();
          svg.selectAll('text').remove();
          text_box.text(text_two);

          // draw mean lines for us and shanghai
          var us_mean = score_scale(get_country_mean(country_means, us)),
              china_mean = score_scale(get_country_mean(country_means, china)),
              us_mean_line = draw_line(left_margin, us_mean, width, us_mean,
                svg, us_color, 2, true),
              china_mean_line = draw_line(left_margin, china_mean, width,
                china_mean, svg, china_color, 2, true);

          // Label mean lines with text
          add_text(svg, wealth_scale(1.2), score_scale(640),
            'Shanghai (China)');
          add_text(svg, wealth_scale(2.1), score_scale(500),
            'USA')

          // draw lines and text highlighting difference between China and US
          add_arrow(svg, wealth_scale(-5), score_scale(557),
            wealth_scale(-5), score_scale(607));
          add_arrow(svg, wealth_scale(-5), score_scale(537),
            wealth_scale(-5), score_scale(487));
          hi_text = add_text(svg, wealth_scale(-6), score_scale(547),
            '130 points = 3 years schooling');

          var lines = svg.selectAll('path')
            .data(countries)
            .enter()

          var first_lines = lines.append('path')
            .filter(function(d) {
              return d['key'] === us || d['key'] === china;
            })
            .attr('d', function(d){
              return line(d['values']);})
            .style('fill', 'none')
            .style('stroke', function(d) {
              if(d['key'] === us) {
                return us_color;
              } else {
                return china_color;
              }
            })
            .style('stroke-width', 2)
            .on('mouseover', function(d){
              return d3.select(this).style('stroke', 'red')
                .style('stroke-width', 3);
            })
            .on('mouseout', function(d){
              return d3.select(this).style('stroke', 'slategrey')
                .style('stroke-width', 1);
            });

          // Add tooltips to lines
          first_lines.append("svg:title")
            .attr("class", "tooltip")
            .text(function(d) {
              var values = d['values'][0]['values'];
              var country = values['country'];
              var score = get_country_mean(country_means, country);
              return country + '\nAverage Score: ' + score;
            });
          setTimeout(function(){

            svg.selectAll("line").remove()
            hi_text.remove();
            draw_line(left_margin, score_scale(402), width, score_scale(402),
              svg, us_color, 2, true);
            draw_line(left_margin, score_scale(509), width, score_scale(509),
              svg, us_color, 2, true);
            draw_line(left_margin, score_scale(455), width, score_scale(455),
              svg, us_color, 2, true);
            draw_line(left_margin, score_scale(640), width, score_scale(640),
              svg, us_color, 2, true);
            add_arrow(svg, wealth_scale(-5), score_scale(635-75),
              wealth_scale(-5), score_scale(630));
            add_arrow(svg, wealth_scale(-5), score_scale(455 + 75),
              wealth_scale(-5), score_scale(460));
            add_arrow(svg, wealth_scale(-5.5), score_scale(509 - 40),
              wealth_scale(-5.5), score_scale(504));
            add_arrow(svg, wealth_scale(-5.5), score_scale(402 + 40),
              wealth_scale(-5.5), score_scale(407));
            add_text(svg, wealth_scale(-5.5), score_scale(545),
              "180 points > years")
            add_text(svg, wealth_scale(-5.4), score_scale(425),
              "100 points > 2 years")
            debugger;

            setTimeout(function() {

              // set us and china lines to standard line color
              first_lines.style('stroke', 'grey')
                .style('stroke-width', 1);

              // change text_box text
              text_box.text(text_three);

              // remove all highlighting text and arrows
              svg.selectAll('line').remove();
              svg.selectAll('text').remove();

              var final_chart = lines.append('path')
                .filter(function(d) {
                  return d['key'] !== us && d['key'] !== china;
                })
                .attr('d', function(d){
                  return line(d['values']);})
                .style('fill', 'none')
                .style('stroke', 'grey')
                .style('stroke-width', 1)
                .on('mouseover', function(d){
                  return d3.select(this).style('stroke', 'red')
                    .style('stroke-width', 3);
                })
                .on('mouseout', function(d){
                  return d3.select(this).style('stroke', 'slategrey')
                    .style('stroke-width', 1);
                });

              // Add tooltips to lines
              final_chart.append("svg:title")
                .attr("class", "tooltip")
                .text(function(d) {
                  var values = d['values'][0]['values'];
                  var country = values['country'];
                  var score = get_country_mean(country_means, country);
                  return country + '\nAverage Score: ' + score;
                });
            }, 30000);
          }, 30000)
        }, 30000, vals);
      };

      function draw(data) {
        var vals = stage_one(data);

        setTimeout(stage_two, 1000, data, vals['svg'], vals['country_means'],
          vals['wealth_scale'], vals['score_scale'],
          vals['wealth_axis'], vals['score_axis']);

        setTimeout(stage_three, 1000, vals);

      };

    </script>
  </head>
<body>
  <script type="text/javascript">

  var header_margin = 10

  var header = d3.select("body")
    .append("div")
    .attr("class", "header")
    .style("margin-left", left_margin + "px")
    .style("width", width - left_margin + "px")
    .style("height", "75px")
    .style("display", "block")

  var title = header.append("h2")
    .style("padding-left", header_margin + "px")
    .style("font-family", font)
    .style("color", text_color)
    .text("PISA 2012 Math Score by Wealth");

  var text_box = header.append("div")
    .attr("class", "text_box")
    .style("padding-left", header_margin + "px")
    .style("width", width - left_margin - 200 +"px")
    .style("height", "50px")
    .style("word-wrap", "break-word")
    .style("font-family", font)
    .style("float", "left")
    .style("color", text_color)
    .text(opening_text);
        
  //Create navigation buttons
  var button = header.append("div")
    .attr("class", "next_button")
    .style("display", "table")
    .style("width", "75px")
    .style("height", "25px")
    .style("float", "right")
    .append("div")
    .style("display", "table-cell")
    .style("border-radius", "5px")
    .style("vertical-align", "middle")
    .style("text-align", "center")
    .style("background", "darkslategrey")
    .style("color", "white")
    .text("NEXT");

  // buttons.on("click", function(d){
  //     clear_svg();
  // });

  var obj = draw_first_stage("pisa_by_wealth.tsv");

  function draw_first_stage(file){
      d3.tsv(file, function(d) {
          // transform data
          d['math_score'] = +d['math_score'];
          d['wealth.bucket'] = +d['wealth.bucket'];
          return d;
      }, draw);
  };
  </script>
</body>
</html>
